# 数字化神经心理评估系统（Android）

本仓库为 **“数字化神经心理评估系统”** 的 Android 客户端工程。

## 背景与目标

神经心理评估大量依赖纸质量表与长时间书写/记录流程，但传统量表长期存在一个痛点：**难以数字化与电子化**，导致数据采集、归档、回溯与规模化研究效率受限。

本系统通过 **点阵码技术 + 智能笔（智能手写笔）**，将量表评估过程与被试书写笔迹进行数字化采集：在不改变评估者/被试使用习惯（仍以纸笔书写为主）的前提下，把**书写轨迹、时间信息、页面/题目映射**等关键数据沉淀为可计算的数据资产。

### 价值与收益

- **流程不变、数据可用**：保留纸质量表的现场可用性与操作习惯，同时获得结构化数据。
- **提升质量控制**：便于追踪缺失页/未完成项目、重复提交、异常数据等（部分校验由服务端实现）。
- **支持规模化研究**：长期随访、社区队列、临床研究等场景中，便于统一采集规范与数据回传。
- **便于回溯与审计**：笔迹与上传记录可用于复核、质控与研究留档。

## 项目基本信息

- **产品名称**：数字化神经心理评估系统  
- **平台**：Android（平板为主，手机可用于演示但可能存在适配差异）  
- **核心能力**：使用 **智能手写笔**采集量表书写笔迹数据，并将数据上传到服务器；支持网络异常时本地缓存与“待上传”重传；提供秒表/TMT 计数器等辅助工具。
- **端侧定位（Android）**：负责 **数据采集与可靠传输**（蓝牙笔连接、量表/页面识别、笔迹回显、上传与本地缓存）。
- **服务端定位**：负责 **数据校验、处理与分析**（例如更复杂的数据清洗、统计/建模、质控规则、报表/管理后台等）。

## APP 功能概览

- **量表书写采集**：在画布上实时显示/记录笔迹轨迹。
- **蓝牙笔连接**：扫描并连接智能笔蓝牙设备。
- **量表/页面识别**：结合点阵码/页面映射信息进行页面识别与数据归档（具体识别与映射细节可按项目实际补充）。
- **数据提交**：
  - **在线提交**：网络可用时直接上传到服务器。
  - **离线缓存**：网络不可用或上传失败时自动缓存到本地。
- **数据重传**：
  - **批量上传**：一键重新上传本地缓存的数据。
  - **单条上传**：点击某条缓存数据，确认后仅上传该条。
  - 上传过程提供 **阻塞式等待提示**，避免重复操作。
- **意见反馈**：从侧边栏进入意见反馈页面，填写后通过邮件客户端发送到指定邮箱。
- **辅助工具**：秒表、TMT 计数器（用于评估过程中的时间/计数辅助）。

## 系统适用场景

面向任何需要 **长时间进行量表评估** 且希望将评估流程 **数字化转型** 的场景，例如：

- **阿尔茨海默病（AD）** 等认知障碍相关量表评估
- **精神疾病** 等长期随访与量表评估场景
- **科研队列/社区队列**：当前已应用于 **中国脑计划社区队列建设**（可根据实际部署范围补充更多落地单位/项目）

## 核心代码模块说明

### 1) 入口与页面容器
- **`MainActivity`**：应用主界面与抽屉导航入口，负责弹窗/Fragment 展示、提交按钮、待上传入口等。
- **`MainDialogFragment`**：启动引导/配置流程（被试编号、蓝牙笔连接等），并对弹窗尺寸/交互做统一控制。

### 2) 笔迹采集与数据结构
- **`DrawingView`**：画布渲染与触控/绘制展示。
- **`StrokeManager` / `StrokePoint` / `PointManager`**：笔迹点数据的缓存、管理与清理。
- **`assets/*.csv` + `CSVReaderUtil`**：量表页面/题目映射与读取（不同量表版本）。

### 3) 蓝牙与 BPen SDK 集成
- **`BluetoothLEService`（第三方）**：BLE 连接服务。
- **`BlueDelegateImpl`**：将厂商 SDK 的数据回调与本地笔迹/画布逻辑衔接。
- **`BLEScanManager` / `BLEScanAdapter`**：蓝牙扫描列表展示与连接交互。

### 4) 上传与重传
- **`OkHttpUtils`**：网络请求封装（POST/GET）。
- **`StrokeUploadManager`**：
  - `submitStrokes(...)`：主界面提交笔迹数据（含网络检查与失败缓存）。
  - `reupload(...)`：批量上传本地缓存。
  - `reuploadSingle(...)`：单条上传本地缓存。
  - 内部负责失败重试、重复提交处理、本地文件删除、刷新“待上传”列表等。
- **`ReuploadDialogFragment`**：待上传弹窗页面（Material 风格、列表/空状态/等待提示）。
- **`ReuploadAdapter`**：待上传文件列表适配器（条目点击上传确认）。

### 5) 用户反馈与信息展示
- **`FeedbackFragment`**：意见反馈表单与邮件发送（Intent 调起邮件客户端）。
- **`AboutUsFragment`**：关于我们信息页（含二维码弹窗）。

## 使用权限说明

权限以 `app/src/main/AndroidManifest.xml` 为准（示例解释如下）：

- **蓝牙相关**：
  - `android.permission.BLUETOOTH` / `BLUETOOTH_ADMIN`：兼容旧版本蓝牙能力
  - `android.permission.BLUETOOTH_SCAN`：扫描 BLE 设备（Android 12+）
  - `android.permission.BLUETOOTH_CONNECT`：连接 BLE 设备（Android 12+）
  - `android.permission.BLUETOOTH_PRIVILEGED`：受保护权限（Manifest 中标注 `tools:ignore`，通常仅系统应用可用）
- **定位相关**：
  - `android.permission.ACCESS_FINE_LOCATION`：部分 Android 版本扫描 BLE 需要定位权限（系统限制）
- **网络相关**：
  - `android.permission.INTERNET`：上传数据、请求服务端接口
  - `android.permission.ACCESS_NETWORK_STATE` / `ACCESS_WIFI_STATE`：检测网络状态，决定在线上传或离线缓存
- **唤醒锁**：
  - `android.permission.WAKE_LOCK`：评估过程中保持屏幕常亮，避免中断

> 说明：权限申请逻辑主要集中在 `PermissionHelper` 与启动流程中；“待上传/提交”会依据网络状态采取不同策略（上传或本地缓存）。

## 数据流简述

1. 扫描/连接蓝牙笔 → 获取书写数据回调  
2. 画布显示 + 本地缓存（StrokeManager）  
3. 点击“提交” → 组装 JSON → OkHttp 上传  
4. 上传失败/网络不可用 → 保存到本地 `.json`  
5. “待上传” → 批量/单条上传 → 成功后删除本地缓存并刷新列表

## 系统要求

### 开发环境
- **Android Studio**: Hedgehog (2023.1.1) 或更高版本
- **JDK**: JDK 8 或更高版本
- **Gradle**: 8.2（项目已包含wrapper）
- **Android SDK**: 
  - 最低支持：Android 8.0 (API 26)
  - 目标版本：Android 13 (API 33)
  - 编译版本：Android 13 (API 33)

### 硬件要求
- 支持蓝牙的Android设备（用于连接BPen手写笔）
- Android 8.0 或更高版本

## 项目结构说明

```
Android/
├── app/
│   ├── libs/                    # 第三方库（BPen SDK, native库）
│   ├── src/
│   │   └── main/
│   │       ├── java/            # Java源代码🚀
│   │       ├── res/             # 资源文件（布局、图片等）
│   │       └── AndroidManifest.xml
│   └── build.gradle             # App模块构建配置
├── build.gradle                  # 项目级构建配置
├── settings.gradle               # 项目设置
└── gradle/                       # Gradle Wrapper
```

